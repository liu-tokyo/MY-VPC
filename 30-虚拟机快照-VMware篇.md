# 虚拟机快照-VMware篇

## 简介：

**快照**是虚拟机磁盘文件在某个点及时的副本  
磁盘“快照”是虚拟机磁盘文件（VMDK）在某个点及时的副本。系统崩溃或系统异常，你可以通过使用恢复到快照来保持磁盘文件系统和系统存储。当升级应用和服务器及给它们打补丁的时候，快照是救世主。VMware快照是VMware Workstation里的一个特色功能。

## 快照使用

如果你创建了多于一个的虚拟机快照，那么，你将有多个还原点可以用于恢复。当你创建了一个快照，那快照在可写的那个点上就变成了只读的。使用in-file delta技术就能创建新文件记录所有的关于原始磁盘文件的变更（delta）。

- 文件大小
快照文件的大小不能超过原始磁盘文件的大小。任何时候，一个磁盘块改变了，就将在delta文件里创建快照并能随着改变而更新。如果进行一次快照后，你改变了每个单独的磁盘存储块，这个快照将仍然象原始磁盘文件那么大。快照文件最初很小（16MB），不过，随着对虚拟磁盘文件的写入将增大。
16MB的快照空间用于降低SCSI预留冲突。当收到改变原始磁盘上存储块的请求，它代替在delta文件里的改变。如果先前在delta文件里更改了的磁盘存储块再次被更改，由于它简单地更新在delta文件里现有的存储块，不会增加delta文件的大小。
- 增长率
快照的增长率由服务器上磁盘写入活动发生次数决定。拥有磁盘写入增强应用的服务器，诸如SQL和Exchange服务器，它们的快照文件增长很快。另一方面，拥有大部分静态内容和少量磁盘写入的服务器，诸如Web和应用服务器，它们的快照文件增长率很低。当你创建许多快照时，新delta文件被创建并且原先的delta文件变成只读的了。每个拥有大量快照的delta文件可能变得和原始磁盘文件一样大。

## 快照类型

当你创建一个虚拟机快照时，这是一个特定的文件。它也是redo-log日志。delta文件是在基础VMDK（虚拟机磁盘）上的变更位图，因此，它不能增长到比VMDK还大。为虚拟机创建每一个快照时，都会创建一个delta文件。当快照被删除或在快照管理里被恢复时，这些文件将自动删除。  
这些文件用于存储关于快照的元数据和信息。这个文件是文本格式的，里面包括诸如快照显示名称、UID（编号）和磁盘文件名等信息。在你没创建虚拟机快照之前，这个文件的初始大小为0字节。这样说来，只要进行快照，这个文件就会增大和持续更新。  
在快照被移开后，这个文件不能被完全清除。一旦你删除了个快照，它将仍然在文件里为每个快照遗留位置，不过仅增加编号并在“Consolidate Helper”里放置名称，这可能是用来整合备份*.vmsn file  
这是快照状态文件，里面存储的是使用快照时，一台虚拟机精确的运行状态。这个文件大还是小取决于你选择保留这台虚拟机的存储作为快照的一部分。如果你选择保留虚拟机的存储，那么，这个文件将比较大，然后分配给虚拟机最大化的RAM。  
这个文件类似于VMware暂停状态文件.vmss。虚拟机每个快照都将创建一个.vmss文件；当移动快照时，这些文件自动删除。

## 创建快照

- 步骤
  你可以通过VMware Infrastructure Client（VI Client）里的Snapshot Manager或直接使用ESX Service控制台上的指令行工具创建快照。使用指令可以启动或关闭一台虚拟机。当创建快照时也可以暂停虚拟机。如果虚拟机切断了电源，你将不能选择对虚拟机存储进行快照。

- 流程
  通过使用直接连接到一台ESX服务器或连接到VirtualCenter的VI Client来管理快照。如果你选择使用命令行界面来代替，创建快照的语法是“vmware-cmd createsnapshot”，例如“vmware-cmd myvm1.vmx createsnapshot snap1 ’before upgrade’ 1 1”。停顿与存储的选择是1或0。选择1将在进行快照前停止文件系统写入。选择1将快照虚拟机存储状态进行存储。如果创建多个快照，一旦新的快照被创建，先前的快照变成只读的。
  
- 菜单选项创建快照

  ![image-20220821044437695](C:\Users\KST_LIUZHIJUN\AppData\Roaming\Typora\typora-user-images\image-20220821044437695.png)

## 删除恢复

- 删除
  当你为一台虚拟机删除所有快照时，所有创建的delta文件被合并到虚拟机原先的VMDK磁盘文件，然后被删除。如果你选择只删除一个单独的快照，这个快照合并到它的父级快照。如果你选择恢复一个快照，当前的磁盘和存储状态被丢弃，虚拟机恢复到快照时的状态。无论你恢复哪个快照， 这个快照就成为新的父级快照。然而，这个父级快照通常不是最近的快照。如果你恢复到一个旧的快照，它就变成虚拟机状态的父级快照。在Snapshot Manager里可以看见这个父级快照，在它下面有一个标签“You are here”。  
  你能使用VI Client或vmware-cmd命令行工具删除或恢复快照。VI Client里的Snapshot Manager提供更高的灵活性，也比CLI（命令行界面）更容易使用。VI Client里的“Revert to Snapshot”选项与Snapshot Manager之间的一个重要差别是，恢复选项简单地恢复到最后一次快照，而Snapshot Manager能灵活地选择恢复到某一特定的快照。这叫做“Go To in Snapshot Manager”。
-  恢复
  如果你使用vmware-cmd，语法是“vmware-cmd removesnapshots”，这能移除所有快照，而“vmware-cmd revertsnapshot”能恢复到最后一个快照。如果你需要移除或恢复特定的快照，你必须使用VI Client。  
  如果你恢复一个不包括存储状态的快照时，服务器将断电，一旦重新启动，将会使用先前的快照。如果快照包括存储状态，虚拟机将暂停，然后回到先前快照的磁盘和存储状态。

## 管理工具

尽管在使用快照的过程当中VMware Tools并不是必须的，但还是强烈推荐使用这种工具。  
VMware Tools允许操作系统停止——或者减少——磁盘活动，因此可以更加轻松地制作快照，而不再需要VMware主机创建PIT复本。  
可以通过多种方式检查快照文件大小，最为简单的方式是使用RVTools或者启用快照大小特性。  
还可以在PowerCLI当中执行以下命令：  

```shell
get-vm | get-snapshot
```

这种方式可以列出目标vCenter当中的所有快照。

## 快照包含的潜在问题

如果你尝试使用vMotion或者Storage vMotion以外的方式来移动虚拟机，那么快照可能会导致一些问题。尽管你可以使用copy命令来复制任何文件，但是如果在具有快照的虚拟机上使用这种方式将会导致文件损坏等情况发生。  
有几种类型虚拟机不能为其制作快照。其中包括使用共享SCSI总线的虚拟机，比如集群服务器。并且不能为单独磁盘制作快照。如果已经启用physical raw device mapping，则不能为其创建快照，因为底层磁盘由虚拟机进行管理。也就是说，如果不是由VMware主机进行管理，便不能为其创建快照。  
如果你运行的是ESXi 4或者之前的版本，那么还需要注意一些其他问题。首先，不能使用Storage vMotion技术迁移一台具有多个快照的虚拟机。最为快速的解决方式是整合所有快照，这意味着不再能够将虚拟机恢复到多个时间点的状态。这种限制在vSphere 5当中被移除。另外一种经常发生的问题是当整合大型快照时，会出现主机暂时无响应的情况，但是主机上的虚拟机仍然在正常运行，这种情况持续一段时间之后会自动消失。

## 尽量避免多个快照

大多数情况下，应该避免为同一台虚拟机创建多个快照；每次为系统创建新的快照，其运行速度都会变慢。每个快照都会建立相应的delta磁盘文件，如果虚拟机需要读取多个delta文件，必然会增加系统的I/O负载。这个过程无疑会延长虚拟机的响应时间，并且产生额外的磁盘操作。  
如果你只想保存一系列快照当中的最新版本，可以将它们整合为单一快照。这种方式可以帮助提升系统运行速度和管理效率。选择目标虚拟机，单击鼠标右键，之后选择整合。你可以在虚拟机和模板视图当中查询虚拟机是否需要整合，并且在列表当中显示所有需要进行整合的虚拟机。

## VMware快照修复VMDK文件

### VMware快照工作原理
当创建VMware快照时，实际上我们并没有复制原始磁盘当中的任何数据。而是将原始磁盘设置为VMware快照读状态，并且创建一个VMware快照回滚日志——有时也称之为增量磁盘，这种增量磁盘其实就是在VMware快照创建之后，针对任何虚拟机写入操作所产生的占位符。

![image-20220821044145226](C:\Users\KST_LIUZHIJUN\AppData\Roaming\Typora\typora-user-images\image-20220821044145226.png)

图1.增量文件当中包含的仅仅是快照创建之后的虚拟机变化部分  
图一展示了VMware快照的工作流程。假设磁盘当中包含了一个单词“SNAPSHOT”，并且每个字母都位于自己的VMware快照磁盘块当中。当我们创建磁盘VMware快照的时候，原始磁盘变为只读状态，一个新的增量VMDK文件被创建。这时第二个块变为“L”，并且“S”被加入到第九个块当中，这样就产生了新的单词“SLAPSHOTS”。  
为了保证所有VMware快照文件都是安全的，我们需要进行一系列操作。我们可以删除VMware快照，这样将会简单地将新的块合并到原始的VMDK文件当中，并且将“SLAPSHOTS”提交给虚拟机——或者我们可以回滚到另外一个时间点，比如磁盘刚刚读入“SNAPSHOT”的时候。每次创建VMware快照的时候，都会创建一个新的增量磁盘，保证我们能够回滚到VMware快照链当中的任何时间点。

### VMware快照能否修复VMDK文件

如果原始VMDK文件遭到破坏或者被删除，那么VMware快照管理员就会面临很多棘手问题。正如图二所示，包含“SNAPSHOT”的原始VMware快照磁盘已经消失。我们手中只剩下了包含字母“L”和“S”的增量磁盘，而指向磁盘的元数据（metadta）已经消失。  
图2.如果只使用损坏或者丢失VMDK文件的VMware快照，那么无法重建原始文件。  

![image-20220821044531969](C:\Users\KST_LIUZHIJUN\AppData\Roaming\Typora\typora-user-images\image-20220821044531969.png)


（这样玩儿快照，是变态、找死的节凑啊！）
也许你已经得出了结论：如果包含“SNAPSHOT”的原始VMware快照磁盘或者原始块丢失，那么使用增量磁盘当中的部分数据无法重建任何东西。

### VMware快照缺失文件种类决

仅仅使用VMware快照文件来恢复丢失的VMDK文件是不可能的，但是根据丢失VMDK文件的不同，我们可能拥有几种解决方案。一个VMware快照虚拟机磁盘由两个不同的文件组成：VMDK文件——虚拟磁盘的最重要组成部分——保存了所有数据，以及描述符文件——VMX文件——为虚拟机配置文件提供相关VMware快照磁盘信息。
如果VMDK文件丢失，那么只能寄希望于保存了VMware快照备份文件，而如果描述符文件丢失，那么可以使用ESXi命令行进行恢复。